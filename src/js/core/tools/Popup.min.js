import CoreFeature from"../CoreFeature.js";import Helpers from"./Helpers.js";export default class Popup extends CoreFeature{constructor(e,t,s){super(e),this.element=t,this.container=this._lookupContainer(),this.parent=s,this.reversedX=!1,this.childPopup=null,this.blurable=!1,this.blurCallback=null,this.renderedCallback=null,this.visible=!1,this.hideable=!0,this.element.classList.add("tabulator-popup-container"),this.blurEvent=this.hide.bind(this,!1),this.escEvent=this._escapeCheck.bind(this),this.destroyBinding=this.tableDestroyed,this.destroyed=!1}tableDestroyed(){this.destroyed=!0,this.hide(!0)}_lookupContainer(){var e=this.table.options.popupContainer;return"string"==typeof e?e=document.querySelector(e):!0===e&&(e=this.table.element),e&&!this._checkContainerIsParent(e)&&(e=!1),e||(e=document.body),e}_checkContainerIsParent(e,t=this.table.element){return e===t||!!t.parentNode&&this._checkContainerIsParent(e,t.parentNode)}renderCallback(e){this.renderedCallback=e}containerEventCoords(e){var t=!(e instanceof MouseEvent),s=t?e.touches[0].pageX:e.pageX,i=t?e.touches[0].pageY:e.pageY;if(this.container!==document.body){let e=Helpers.elOffset(this.container);s-=e.left,i-=e.top}return{x:s,y:i}}elementPositionCoords(e,t="right"){var s,i,n,o=Helpers.elOffset(e);switch(this.container!==document.body&&(s=Helpers.elOffset(this.container),o.left-=s.left,o.top-=s.top),t){case"right":i=o.left+e.offsetWidth,n=o.top-1;break;case"bottom":i=o.left,n=o.top+e.offsetHeight;break}return{x:i,y:n,offset:o}}show(e,t){var s,i,n,o,r;return this.destroyed||this.table.destroyed||(e instanceof HTMLElement?(n=e,o=(r=this.elementPositionCoords(e,t)).offset,s=r.x,i=r.y):"number"==typeof e?(o={top:0,left:0},s=e,i=t):(s=(r=this.containerEventCoords(e)).x,i=r.y,this.reversedX=!1),this.element.style.top=i+"px",this.element.style.left=s+"px",this.container.appendChild(this.element),"function"==typeof this.renderedCallback&&this.renderedCallback(),this._fitToScreen(s,i,n,o,t),this.visible=!0,this.subscribe("table-destroy",this.destroyBinding),this.element.addEventListener("mousedown",(e=>{e.stopPropagation()}))),this}cellshow(e,t){var s,i,n,o,r;return this.destroyed||this.table.destroyed||(e instanceof HTMLElement?(n=e,o=(r=this.elementPositionCoords(e,t)).offset,s=r.x,i=r.y):"number"==typeof e?(o={top:0,left:0},s=e,i=t):(s=(r=this.containerEventCoords(e)).x,i=r.y,this.reversedX=!1),this.element.style.top=i+"px",this.element.style.left=s+"px",this.container.appendChild(this.element),"function"==typeof this.renderedCallback&&this.renderedCallback(),this._fitToScreen(s,i,n,o,t),this.visible=!0,this.subscribe("table-destroy",this.destroyBinding),this.element.addEventListener("mousedown",(e=>{e.stopPropagation()}))),this}_fitToScreen(e,t,s,i,n){var o=this.container===document.body?document.documentElement.scrollTop:this.container.scrollTop;if((e+this.element.offsetWidth>=this.container.offsetWidth||this.reversedX)&&(this.element.style.left="",this.element.style.right=s?this.container.offsetWidth-i.left+"px":this.container.offsetWidth-e+"px",this.reversedX=!0),t+this.element.offsetHeight>Math.max(this.container.offsetHeight,o?this.container.scrollHeight:0))if(s)switch(n){case"bottom":this.element.style.top=parseInt(this.element.style.top)-this.element.offsetHeight-s.offsetHeight-1+"px";break;default:this.element.style.top=parseInt(this.element.style.top)-this.element.offsetHeight+s.offsetHeight+1+"px"}else this.element.style.top=parseInt(this.element.style.top)-this.element.offsetHeight+"px"}isVisible(){return this.visible}hideOnBlur(e){return this.blurable=!0,this.visible&&(setTimeout((()=>{this.table.rowManager.element.addEventListener("scroll",this.blurEvent),this.subscribe("cell-editing",this.blurEvent),document.body.addEventListener("click",this.blurEvent),document.body.addEventListener("contextmenu",this.blurEvent),document.body.addEventListener("mousedown",this.blurEvent),window.addEventListener("resize",this.blurEvent),document.body.addEventListener("keydown",this.escEvent)}),100),this.blurCallback=e),this}_escapeCheck(e){27==e.keyCode&&this.hide()}blockHide(){this.hideable=!1}restoreHide(){this.hideable=!0}hide(e=!1){return this.visible&&this.hideable&&(this.blurable&&(document.body.removeEventListener("keydown",this.escEvent),document.body.removeEventListener("click",this.blurEvent),document.body.removeEventListener("contextmenu",this.blurEvent),document.body.removeEventListener("mousedown",this.blurEvent),window.removeEventListener("resize",this.blurEvent),this.table.rowManager.element.removeEventListener("scroll",this.blurEvent),this.unsubscribe("cell-editing",this.blurEvent)),this.childPopup&&this.childPopup.hide(),this.parent&&(this.parent.childPopup=null),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.visible=!1,this.blurCallback&&!e&&this.blurCallback(),this.unsubscribe("table-destroy",this.destroyBinding)),this}child(e){return this.childPopup&&this.childPopup.hide(),this.childPopup=new Popup(this.table,e,this),this.childPopup}}